<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Todo Manager — Auth Enabled</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .completed { text-decoration: line-through; opacity: 0.7; }
    .due-overdue {
      border-left: 4px solid #dc3545;
      background-color: rgba(220,53,69,0.03);
    }
    .due-soon {
      border-left: 4px solid #fd7e14;
      background-color: rgba(253,126,20,0.03);
    }
    .badge-due-overdue { background-color: #dc3545; color: white; }
    .badge-due-soon { background-color: #fd7e14; color: black; }

    .modal .alert { margin-bottom: 1rem; }
    .password-hint { font-size: 0.85rem; color: #6c757d; }
    .password-weak { color: #dc3545; }
    .password-ok { color: #198754; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3">Todo Manager</h1>
      <div id="authControls" class="d-flex gap-2 align-items-center">
        <!-- Filled by JS -->
      </div>
    </div>

    <div id="globalMessageArea" class="mb-3"></div>

    <div class="card mb-4">
      <div class="card-body">
        <div class="row gy-2 align-items-center">
          <div class="col-auto">
            <label class="me-2">Show:</label>
            <select id="filter" class="form-select form-select-sm">
              <option value="all">All tasks</option>
              <option value="0">Incomplete</option>
              <option value="1">Completed</option>
            </select>
          </div>
          <div class="col-auto ms-3">
            <input id="search" class="form-control form-control-sm" style="width:260px;" placeholder="Search title or description" />
          </div>
          <div class="col"></div>
          <div class="col-auto text-muted small">
            Tip: login to add and manage your tasks.
          </div>
        </div>
      </div>
    </div>

    <div id="tasksContainer"></div>
  </div>

  <!-- Add Task Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">Add Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="addError" class="alert alert-danger d-none" role="alert"></div>

          <div class="mb-3">
            <label class="form-label">Title</label>
            <input id="add_title" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="add_description" class="form-control" rows="3"></textarea>
          </div>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Due date</label>
              <input id="add_due_date" type="date" class="form-control" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Priority</label>
              <select id="add_priority" class="form-select">
                <option value="1">High</option>
                <option value="2" selected>Medium</option>
                <option value="3">Low</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add task</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="editError" class="alert alert-danger d-none" role="alert"></div>

          <input type="hidden" id="edit_id" />
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input id="edit_title" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea id="edit_description" class="form-control" rows="3"></textarea>
          </div>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Due date</label>
              <input id="edit_due_date" type="date" class="form-control" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Priority</label>
              <select id="edit_priority" class="form-select">
                <option value="1">High</option>
                <option value="2">Medium</option>
                <option value="3">Low</option>
              </select>
            </div>
          </div>
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="edit_completed">
            <label class="form-check-label" for="edit_completed">Completed</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Account Modal (keeps simple for now) -->
  <div class="modal fade" id="accountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="accountForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">My account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div id="accountError" class="alert alert-danger d-none" role="alert"></div>
          <div id="accountSuccess" class="alert alert-success d-none" role="status"></div>

          <div class="mb-3">
            <label class="form-label">Current password</label>
            <input id="acct_current" type="password" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">New password</label>
            <input id="acct_new" type="password" class="form-control" required />
            <div class="form-text">New password must be at least 6 characters.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Confirm new password</label>
            <input id="acct_confirm" type="password" class="form-control" required />
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Change password</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Login & Register Modals -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="loginForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="loginError" class="alert alert-danger d-none" role="alert"></div>

          <div class="mb-3">
            <label class="form-label">Username</label>
            <input id="login_username" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input id="login_password" type="password" class="form-control" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Login</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="registerForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Register</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="registerError" class="alert alert-danger d-none" role="alert"></div>

          <div class="mb-3">
            <label class="form-label">Username</label>
            <input id="reg_username" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input id="reg_password" type="password" class="form-control" required />
            <div class="form-text">Password must be at least 6 characters.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Register</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Globals
    const api = '/api/tasks';
    let searchTimeout = null;
    let editModalInstance = null;
    let addModalInstance = null;
    let loginModalInstance = null;
    let registerModalInstance = null;
    let accountModalInstance = null;
    let currentUser = null;

    // Render function (global) — ensures fetchTasks can always call it
    function renderTasks(tasks) {
      const container = document.getElementById('tasksContainer');
      if (!container) return;

      if (!tasks || tasks.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No tasks yet. Add one using Add Task.</div>';
        return;
      }

      function escapeHtml(text) {
        if (!text) return '';
        return String(text).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      }

      function priorityBadge(p) {
        if (p == 1) return '<span class="badge bg-danger">High</span>';
        if (p == 2) return '<span class="badge bg-warning text-dark">Medium</span>';
        return '<span class="badge bg-secondary">Low</span>';
      }

      function daysUntil(dueDateStr) {
        if (!dueDateStr) return null;
        const today = new Date();
        const parts = String(dueDateStr).split('-');
        if (parts.length !== 3) return null;
        const due = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
        const diffMs = due - new Date(today.getFullYear(), today.getMonth(), today.getDate());
        return Math.round(diffMs / (1000 * 60 * 60 * 24));
      }

      let html = '<div class="list-group">';
      tasks.forEach(t => {
        const cls = t.completed ? 'completed' : '';
        const days = daysUntil(t.due_date);
        let dueClass = '';
        let dueBadge = '';
        if (days !== null) {
          if (days < 0) {
            dueClass = 'due-overdue';
            dueBadge = '<span class="badge badge-due-overdue ms-2">Overdue</span>';
          } else if (days <= 3) {
            dueClass = 'due-soon';
            dueBadge = '<span class="badge badge-due-soon ms-2">Due soon</span>';
          }
        }

        html += `
          <div class="list-group-item d-flex gap-3 align-items-start ${dueClass}">
            <div class="flex-fill">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="${cls} mb-1" style="cursor:pointer" onclick="openEditModal(${t.id})">${escapeHtml(t.title)} ${priorityBadge(t.priority)} ${dueBadge}</h5>
                <small class="text-muted">${t.due_date ? t.due_date : ''}</small>
              </div>
              <p class="mb-1 ${cls}">${escapeHtml(t.description || '')}</p>
              <small class="text-muted">Created: ${t.created_at}</small>
            </div>
            <div class="btn-group-vertical">
              <button class="btn btn-sm btn-outline-success" title="Toggle complete" onclick="toggleComplete(${t.id})">
                ${t.completed ? '&#x2714;' : '&#x25FB;'}
              </button>
              <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(${t.id})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${t.id})">Delete</button>
            </div>
          </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }
    // Expose it globally to be safe
    window.renderTasks = renderTasks;

    // UI helper: show/hide inline modal errors & global messages
    function showModalError(elemId, message) {
      const el = document.getElementById(elemId);
      if (!el) return;
      el.textContent = message || '';
      el.classList.remove('d-none');
    }
    function hideModalError(elemId) {
      const el = document.getElementById(elemId);
      if (!el) return;
      el.textContent = '';
      el.classList.add('d-none');
    }
    function showModalSuccess(elemId, message) {
      const el = document.getElementById(elemId);
      if (!el) return;
      el.textContent = message || '';
      el.classList.remove('d-none');
    }
    function hideModalSuccess(elemId) {
      const el = document.getElementById(elemId);
      if (!el) return;
      el.textContent = '';
      el.classList.add('d-none');
    }
    function showGlobalMessage(type, message, timeout = 4000) {
      const area = document.getElementById('globalMessageArea');
      area.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      if (timeout) setTimeout(() => { area.innerHTML = ''; }, timeout);
    }

    document.addEventListener('DOMContentLoaded', () => {
      editModalInstance = new bootstrap.Modal(document.getElementById('editModal'), { backdrop: 'static' });
      addModalInstance = new bootstrap.Modal(document.getElementById('addModal'), { backdrop: 'static' });
      loginModalInstance = new bootstrap.Modal(document.getElementById('loginModal'));
      registerModalInstance = new bootstrap.Modal(document.getElementById('registerModal'));
      accountModalInstance = new bootstrap.Modal(document.getElementById('accountModal'));

      renderAuthControls();
      initAuth();
    });

    // Auth & UI rendering
    function renderAuthControls() {
      const container = document.getElementById('authControls');
      container.innerHTML = '';
      if (currentUser) {
        const userBadge = document.createElement('div');
        userBadge.className = 'text-muted small';
        userBadge.textContent = 'Signed in as ' + currentUser.username;
        container.appendChild(userBadge);

        const acctBtn = document.createElement('button');
        acctBtn.className = 'btn btn-sm btn-outline-secondary';
        acctBtn.textContent = 'My account';
        acctBtn.onclick = () => {
          hideModalError('accountError'); hideModalSuccess('accountSuccess');
          document.getElementById('accountForm').reset();
          accountModalInstance.show();
        };
        container.appendChild(acctBtn);

        const addBtn = document.createElement('button');
        addBtn.id = 'openAddBtn';
        addBtn.className = 'btn btn-sm btn-primary';
        addBtn.textContent = 'Add Task';
        addBtn.onclick = () => { hideModalError('addError'); document.getElementById('addForm').reset(); addModalInstance.show(); };
        container.appendChild(addBtn);

        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'btn btn-sm btn-outline-secondary';
        logoutBtn.textContent = 'Logout';
        logoutBtn.onclick = logout;
        container.appendChild(logoutBtn);
      } else {
        const loginBtn = document.createElement('button');
        loginBtn.className = 'btn btn-sm btn-outline-primary';
        loginBtn.textContent = 'Login';
        loginBtn.onclick = () => { hideModalError('loginError'); document.getElementById('loginForm').reset(); loginModalInstance.show(); };
        container.appendChild(loginBtn);

        const regBtn = document.createElement('button');
        regBtn.className = 'btn btn-sm btn-primary';
        regBtn.textContent = 'Register';
        regBtn.onclick = () => { hideModalError('registerError'); document.getElementById('registerForm').reset(); registerModalInstance.show(); };
        container.appendChild(regBtn);
      }
    }

    async function initAuth() {
      try {
        const res = await fetch('/auth/me', { credentials: 'include' });
        if (res.ok) {
          const user = await res.json();
          currentUser = user;
        } else {
          currentUser = null;
        }
      } catch (err) {
        currentUser = null;
      }
      renderAuthControls();
      fetchTasks();
    }

    // Fetch tasks (calls global renderTasks)
    async function fetchTasks() {
      if (!currentUser) {
        document.getElementById('tasksContainer').innerHTML = '<div class="alert alert-info">Please login or register to see and manage your tasks.</div>';
        return;
      }

      const filter = document.getElementById('filter').value;
      const search = document.getElementById('search').value.trim();
      const params = new URLSearchParams();
      if (filter !== 'all') params.append('completed', filter);
      if (search !== '') params.append('search', search);
      const q = params.toString() ? '?' + params.toString() : '';
      const res = await fetch(api + q, { credentials: 'include' });
      if (res.status === 401) {
        currentUser = null;
        renderAuthControls();
        document.getElementById('tasksContainer').innerHTML = '<div class="alert alert-info">Session expired. Please log in again.</div>';
        return;
      }
      const tasks = await res.json();
      // call the global render function
      if (typeof renderTasks === 'function') {
        renderTasks(tasks);
      } else {
        console.error('renderTasks is not a function');
      }
    }

    // Add task handler
    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideModalError('addError');

      if (!currentUser) return showGlobalMessage('danger', 'Please login to add tasks.');

      const title = document.getElementById('add_title').value.trim();
      const description = document.getElementById('add_description').value.trim();
      const due_date = document.getElementById('add_due_date').value || null;
      const priority = parseInt(document.getElementById('add_priority').value, 10);
      if (!title) return showModalError('addError', 'Title is required');

      const res = await fetch(api, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title, description, due_date, priority })
      });
      if (res.ok) {
        document.getElementById('addForm').reset();
        addModalInstance.hide();
        showGlobalMessage('success', 'Task added');
        fetchTasks();
      } else {
        const err = await res.json().catch(()=>({ error: 'Server error' }));
        showModalError('addError', err.error || 'Error creating task');
      }
    });

    // Toggle complete
    async function toggleComplete(id) {
      if (!currentUser) return showGlobalMessage('danger', 'Please login.');
      const res = await fetch(`${api}/${id}/toggle`, { method: 'PATCH', credentials: 'include' });
      if (res.status === 401) { currentUser = null; renderAuthControls(); return; }
      fetchTasks();
    }

    // Delete task
    async function deleteTask(id) {
      if (!currentUser) return showGlobalMessage('danger', 'Please login.');
      if (!confirm('Delete this task?')) return;
      const res = await fetch(`${api}/${id}`, { method: 'DELETE', credentials: 'include' });
      if (res.status === 401) { currentUser = null; renderAuthControls(); return; }
      if (!res.ok) {
        const err = await res.json().catch(()=>({ error: 'Server error' }));
        showGlobalMessage('danger', err.error || 'Delete failed');
        return;
      }
      showGlobalMessage('success', 'Task deleted');
      fetchTasks();
    }

    // Open edit modal (fetch tasks and find one by id)
    async function openEditModal(id) {
      if (!currentUser) return showGlobalMessage('danger', 'Please login.');
      const res = await fetch(`${api}`, { credentials: 'include' });
      if (res.status === 401) { currentUser = null; renderAuthControls(); return; }
      const tasks = await res.json();
      const t = tasks.find(x => x.id === id);
      if (!t) return showGlobalMessage('danger', 'Task not found');
      hideModalError('editError');
      document.getElementById('edit_id').value = t.id;
      document.getElementById('edit_title').value = t.title || '';
      document.getElementById('edit_description').value = t.description || '';
      document.getElementById('edit_due_date').value = t.due_date || '';
      document.getElementById('edit_priority').value = t.priority || 2;
      document.getElementById('edit_completed').checked = !!t.completed;
      editModalInstance.show();
    }

    // Edit save
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideModalError('editError');
      if (!currentUser) return showGlobalMessage('danger', 'Please login.');
      const id = document.getElementById('edit_id').value;
      const title = document.getElementById('edit_title').value.trim();
      const description = document.getElementById('edit_description').value.trim();
      const due_date = document.getElementById('edit_due_date').value || null;
      const priority = parseInt(document.getElementById('edit_priority').value, 10);
      const completed = document.getElementById('edit_completed').checked ? 1 : 0;

      if (!title) return showModalError('editError', 'Title is required');

      const res = await fetch(`${api}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title, description, due_date, priority, completed })
      });

      if (res.ok) {
        editModalInstance.hide();
        showGlobalMessage('success', 'Task updated');
        fetchTasks();
      } else {
        const err = await res.json().catch(()=>({ error: 'Server error' }));
        showModalError('editError', err.error || 'Error updating task');
      }
    });

    // Auth: register/login/logout
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideModalError('registerError');
      const username = document.getElementById('reg_username').value.trim();
      const password = document.getElementById('reg_password').value;
      if (!username || !password) return showModalError('registerError', 'username and password required');
      const res = await fetch('/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });
      if (res.ok) {
        const user = await res.json();
        currentUser = user;
        registerModalInstance.hide();
        renderAuthControls();
        showGlobalMessage('success', 'Registered and logged in');
        fetchTasks();
      } else {
        const err = await res.json().catch(()=>({ error: 'Server error' }));
        showModalError('registerError', err.error || 'Registration failed');
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideModalError('loginError');
      const username = document.getElementById('login_username').value.trim();
      const password = document.getElementById('login_password').value;
      if (!username || !password) return showModalError('loginError', 'username and password required');
      const res = await fetch('/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
      });
      if (res.ok) {
        const user = await res.json();
        currentUser = user;
        loginModalInstance.hide();
        renderAuthControls();
        showGlobalMessage('success', 'Logged in');
        fetchTasks();
      } else {
        const err = await res.json().catch(()=>({ error: 'Server error' }));
        showModalError('loginError', err.error || 'Login failed');
      }
    });

    async function logout() {
      await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
      currentUser = null;
      renderAuthControls();
      showGlobalMessage('info', 'Logged out');
      fetchTasks();
    }

    // Wire filter/search events
    document.getElementById('filter').addEventListener('change', fetchTasks);
    document.getElementById('search').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(fetchTasks, 300);
    });

    // done
  </script>
</body>
</html>